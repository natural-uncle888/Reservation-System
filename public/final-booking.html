<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="#2563eb" name="theme-color"/>
<title>安排時段填寫</title>
<link href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" rel="icon" type="image/png"/>
<style>
    :root { --brand:#2563eb; --ink:#111827; --muted:#6b7280; --card:#f9fafb; --line:#e5e7eb; }
    * { box-sizing: border-box; }
    body { font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; margin:0; color:var(--ink); background:#fff; }

    /* ===== Header ===== */
    .header { padding: 22px 16px; border-bottom:1px solid var(--line); background:#fff; }
    .wrap { max-width: 960px; margin: 0 auto; }
    .header h1 { margin: 0; color: var(--brand); font-size: 1.5rem; }
    .desc { color: var(--muted); margin-top: 6px; }

    /* ===== Form sections (stacked) ===== */
    form { max-width: 960px; margin: 16px auto; padding: 0 16px; }
    .section { background: var(--card); border:1px solid var(--line); border-radius: 12px; padding: 16px; margin: 16px 0; overflow: hidden; }
    .section h2 { margin: 0 0 8px; color: var(--brand); font-size: 1.1rem; }
    .section h2.req::after { content: " *"; color:#dc2626; margin-left:4px; font-weight:700; }
    p.help { margin: 6px 0 0; color: var(--muted); font-size:.95rem; }

    /* ===== Option cards (checkbox/radio) ===== */
    .group { display:flex; flex-direction: column; gap: 14px; margin-bottom: 10px; }
    label.option-card { display:flex; align-items:center; gap:14px; background:#fff; border:2px solid #e5e7eb; border-radius:16px; padding:16px 14px; font-size:1.06rem; box-shadow:0 1px 8px rgba(0,0,0,0.04); cursor:pointer; min-height:48px; transition: border .13s, box-shadow .13s, background .12s; }
    label.option-card:active { background:#e0e7ff; border-color:#2563eb; }
    label.option-card input[type="checkbox"], label.option-card input[type="radio"] { accent-color:#2563eb; width:22px; height:22px; margin:0 6px 0 0; flex-shrink:0; }
    .option-card.selected { border: 2.5px solid #2563eb; background:#e0e7ff; box-shadow:0 2px 12px rgba(37,99,235,0.10); }

    /* ===== Hidden extra inputs (for "其他") ===== */
    .hidden-input { display:none; margin: 2px 0 0 34px; }
    .hidden-input input, .hidden-input textarea { width: 100%; max-width: 100%; padding:12px 14px; border:1px solid #cbd5e1; border-radius:12px; font-size:1.06rem; line-height:1.5; min-height:48px; }

    /* ===== Textarea / table ===== */
    textarea { width: 100%; padding: 10px; border:1px solid #cbd5e1; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: .98rem; background:#fff; border:1px solid var(--line); border-radius:10px; overflow:hidden; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 12px; text-align:left; vertical-align: top; }
    th { width: 34%; color:#334155; background:#f8fafc; }

    /* ===== Tips / details ===== */
    .aside { display:grid; gap:6px; margin-top: 8px; }
    .aside .tip { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; color:var(--muted); font-size:.92rem; }
    details { background:#fff; border:1px dashed var(--line); border-radius:10px; padding:10px; }
    details>summary { cursor:pointer; font-weight:700; color:var(--ink); }

    /* ===== Bottom nav ===== */
    .nav { display:flex; gap:12px; max-width:960px; margin: 18px auto; padding: 0 16px; }
    .nav a, .nav button { flex:1; text-align:center; padding:12px 16px; background:var(--brand); color:#fff; border-radius:10px; text-decoration:none; border:none; cursor:pointer; font: 500 16px/1.5 "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .nav a:hover, .nav button:hover { background:#1e40af; }

    /* ===== Active micro-interactions ===== */
    .card:active, .go:active, button:active { box-shadow:0 2px 12px rgba(37,99,235,0.12); filter:brightness(0.98); transition: box-shadow .05s; }
    button, .go, .card { transition: box-shadow .18s, transform .10s, filter .10s; cursor:pointer; }

    /* ===== Responsive safe-guards ===== */
    body, html { max-width:100%; overflow-x:hidden; }
    img { max-width:100%; height:auto; }
    table, input, select, textarea, button { max-width:100%; box-sizing:border-box; }

    /* ===== FAB (mobile only) ===== */
    .fab-home { position:fixed; right:18px; bottom:72px; width:54px; height:54px; background:#2563eb; color:#fff; border-radius:50%; box-shadow:0 2px 12px rgba(37,99,235,0.08); display:flex; align-items:center; justify-content:center; font-size:2.1em; z-index:1010; text-decoration:none; transition: background .13s, transform .13s; border:none; }
    .fab-home:active { background:#1d4ed8; transform:scale(0.92); }
    
    /* ===== Error state (可對接驗證) ===== */
    .input-error { color:#dc2626; background:#fef2f2; border-radius:8px; padding:6px 10px; margin-top:6px; font-size:.93rem; font-weight:600; }
    .form-row.error input, .form-row.error textarea, .form-row.error select { border: 2px solid #dc2626; background:#fef2f2; }
      /* ===== Two-column layout for upper part ===== */
    .two-col { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .two-col .full { grid-column: 1 / -1; }
    
    .option-card{ width:100%; }
    .two-col .hidden-input{ grid-column: 1 / -1; }
    /* ==== Unified form control sizing to match option cards ==== */
    input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="datetime-local"], select {
      width: 100%; padding: 12px 14px; border:1px solid #cbd5e1; border-radius:12px;
      font-size: 1.06rem; line-height: 1.5; min-height:48px; background:#fff;
    }
    ::placeholder { color:#94a3b8; }
    input[type="text"], input[type="tel"], input[type="email"], input[type="number"], input[type="datetime-local"], select, textarea {
      box-shadow: none; outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color:#2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,.18);
    }
  </style>
</head>
<body>
<!-- Header -->
<div class="header">
<div class="wrap">
<h1>安排時段填寫</h1>
<p class="desc">請選擇可安排時段並補充說明。下方提供送出前預覽。</p>
</div>
</div>
<!-- Form (stacked sections) -->
<form action="#" id="booking-form" onsubmit="return false;">
<!-- 可安排時段 -->
<div class="section">
<h2 class="req req">可安排時段（可複選）</h2>
<div class="group two-col" id="timeslot">
<label class="option-card"><input name="timeslot" type="checkbox" value="平日"/>平日</label>
<label class="option-card"><input name="timeslot" type="checkbox" value="假日"/>假日</label>
<label class="option-card"><input name="timeslot" type="checkbox" value="上午"/>上午</label>
<label class="option-card"><input name="timeslot" type="checkbox" value="下午"/>下午</label>
<label class="option-card"><input name="timeslot" type="checkbox" value="晚上"/>晚上</label>
<label class="option-card"><input name="timeslot" type="checkbox" value="皆可"/>皆可</label>
<label class="option-card"><input data-other-id="time_other" name="timeslot" type="checkbox" value="其他指定時間"/>其他指定時間</label>
<div class="hidden-input full" id="time_other_wrap">
<input id="time_other" name="time_other" placeholder="例如 6/9 09:00–11:00"/>
</div>
</div>
<details><summary>送出後流程</summary><p>我司將收到您的預約資料，人員會於「方便聯繫時間」內與您聯絡，確認細節與到府時間。</p></details>
</div>
<!-- 其他備註說明 -->
<div class="section">
<h2>其他備註說明</h2>
<textarea name="note" placeholder="可補充社區停車、門禁、寵物、聯絡前需簡訊告知等資訊" rows="4"></textarea>
</div>
<!-- 送出前預覽（移到最下面） -->
<div class="section">
<h2>送出前預覽</h2>
<table id="preview"><tbody></tbody></table>
</div>
<!-- 導覽按鈕 -->
<div class="nav">
<a href="contact.html" id="back">返回上一步</a>
<button id="submit" type="button">完成填寫並送出</button>
</div>
</form>
<!-- 提交成功彈窗 -->
<div class="ok" id="ok" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); align-items:center; justify-content:center; z-index:10000;">
<div class="modal" style="background:#fff; border-radius:12px; padding:24px; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,.25);">
<h3>已送出</h3>
<p>感謝您填寫預約資料🙏</p>
<p>我們將盡快與您聯繫，安排最合適的清洗服務時段！</p>
</div>
</div>
<!-- FAB 回首頁（行動版） -->
<a aria-label="回首頁" class="fab-home" href="index.html">🏠</a>
<script>
    (function(){
      const KEY='BOOKING_DATA';
      const FN='/submit';
      const form = document.getElementById('booking-form');
      const $ = s => document.querySelector(s);

      function toggleOtherWrap(name){
        form.querySelectorAll('input[name="'+name+'"]').forEach(el=>{
          const id = el.dataset.otherId;
          const wrap = id && document.getElementById(id + '_wrap');
          if (wrap) wrap.style.display = el.checked ? 'block' : 'none';
        });
      }

      function collect(){
        const out = {};
        form.querySelectorAll('input[name],select[name],textarea[name]').forEach(el=>{
          const n = el.name; if(!n) return;
          if (el.type === 'checkbox') {
            if (!el.checked) return;
            let v = el.value || '';
            const oid = el.dataset.otherId;
            if (oid) {
              const extra = (form.querySelector('#'+oid)?.value||'').trim();
              if (extra) v = v + '：' + extra;
            }
            (out[n]||(out[n]=[])).push(v);
          } else {
            const v = (el.value||'').trim();
            if (v) out[n]=v;
          }
        });
        return out;
      }

      function preview(payload){
        const tbody = document.querySelector('#preview tbody');
        tbody.innerHTML = '';
        const show = (k,label)=>{
          const v = payload[k];
          if(v==null || v==='' || (Array.isArray(v)&&!v.length)) return;
          const txt = Array.isArray(v) ? v.join('、') : v;
          const tr = document.createElement('tr');
          tr.innerHTML = '<th>'+label+'</th><td>'+txt+'</td>';
          tbody.appendChild(tr);
        };
        // === 舊版完整欄位回填 ===
        show('service_category','服務類別');
        show('ac_type','冷氣類型');
        show('ac_count','清洗數量');
        show('indoor_floor','室內機所在樓層');
        show('ac_brand','冷氣品牌');
        show('ac_transformer_series','是否為變形金剛系列');
        show('anti_mold','防霉抗菌');
        show('ozone','臭氧消毒');
        show('washer_count','洗衣機台數');
        show('washer_floor','洗衣機樓層');
        show('tank_count','水塔顆數');
        show('pipe_service','水管清洗戶型');
        show('pipe_reason','水管清洗原因');
        show('contact_method','聯繫方式');
        show('social_name','LINE/FB 名稱');
        show('name','顧客姓名');
        show('phone','聯繫電話');
        show('address','地址');
        show('housing_type','居住地型態');
        show('contact_time_preference','方便聯繫時間');
        // 本頁欄位
        show('timeslot','可安排時段');
        show('note','備註');
      }

      function buildPayload(){
        let prev = {};
        try { prev = JSON.parse(localStorage.getItem(KEY)||'{}'); } catch(e){}
        const formData = collect();
        return Object.assign({}, prev, formData, { _page:{title:document.title,path:location.pathname,url:location.href}, _final:true });
      }

      function refresh(){
        const p = buildPayload();
        window.lastPayload = p;
        preview(p);
      }

      // 初始狀態
      ['timeslot'].forEach(n=>{
        form.querySelectorAll('input[name="'+n+'"]').forEach(el=>{
          el.addEventListener('change', ()=>{ toggleOtherWrap(n); refresh(); save(); });
        });
        toggleOtherWrap(n);
      });
      form.addEventListener('input', ()=>{ refresh(); save(); });

      function save(){
        try { localStorage.setItem(KEY, JSON.stringify(buildPayload())); } catch(e){}
      }

      // 樣式同步：選中時給卡片高亮
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.group').forEach(function(group){
          group.querySelectorAll('input[type="checkbox"],input[type="radio"]').forEach(function(input){
            function sync(){
              if(input.checked) input.closest('.option-card')?.classList.add('selected');
              else input.closest('.option-card')?.classList.remove('selected');
            }
            input.addEventListener('change', sync);
            sync();
          });
        });
      });

      // 返回鍵：保留資料
      document.getElementById('back')?.addEventListener('click', ()=>{ save(); }, {capture:true});

      // 送出
      document.getElementById('submit')?.addEventListener('click', async ()=>{
  const loading = document.getElementById('loading');
  loading.style.display = 'flex';
        const payload = buildPayload();
        try{
          const res = await fetch(FN, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const t = await res.text();
          if(!res.ok) throw new Error('['+res.status+'] '+t);
          document.getElementById('ok').style.display='flex';
          setTimeout(()=>{ localStorage.removeItem(KEY); location.href='index.html'; }, 1200);
        }catch(err){
          alert('提交失敗：'+err.message);
        }
      });

      // 初次渲染
      refresh();
    })();
  </script>
<script>
  // === 必填驗證：可安排時段（可複選） — 強化版：阻止預設並阻止事件傳遞 ===
  (function () {
    function timeslotValid() {
      var checked = document.querySelectorAll('input[name="timeslot"]:checked');
      return checked && checked.length > 0;
    }
    function ensureGroupInView() {
      var grp = document.getElementById('timeslot-group');
      if (grp && grp.scrollIntoView) grp.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    function guardAndBlock(e) {
      if (!timeslotValid()) {
        if (e) {
          e.preventDefault();
          if (e.stopImmediatePropagation) e.stopImmediatePropagation();
          else if (e.stopPropagation) e.stopPropagation();
        }
        alert('請至少選擇一個可安排時段');
        ensureGroupInView();
        return false;
      }
      return true;
    }

    // 1) 攔截提交按鈕 click（捕獲階段，先於其他監聽器執行）
    document.addEventListener('DOMContentLoaded', function () {
      var submitBtn = document.getElementById('submit') ||
                      document.querySelector('button[type="submit"], input[type="submit"], [data-role="submit"]');
      if (submitBtn) {
        submitBtn.addEventListener('click', function (e) {
          guardAndBlock(e);
        }, true); // 捕獲
      }
    });

    // 2) 同時攔截表單 submit（無論透過鍵盤或程式呼叫）
    document.addEventListener('submit', function (e) {
      if (!guardAndBlock(e)) return false;
    }, true); // 捕獲

  })();
</script>
<!-- 等待動畫區塊 -->
<div id="loading" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.75); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center;">
<div class="spinner"></div>
<div style="margin-top:16px; font-size:1.1rem; color:#2563eb; font-weight:500;">資料送出中...請稍候</div>
</div>
<!-- CSS -->
<style>
.spinner {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  position: relative;
  animation: spinnerRotate 1s linear infinite;
}
.spinner::before {
  content: '';
  box-sizing: border-box;
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  border-radius: 50%;
  border: 4px solid transparent;
  border-top-color: #2563eb;
  animation: spinnerSpin 0.6s linear infinite;
}
@keyframes spinnerRotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
@keyframes spinnerSpin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</body>
</html>
