<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>預約資料管理（Cloudinary）</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --accent:#60a5fa; --danger:#f87171; --ok:#34d399;
      --row:#0c1226; --rowHover:#132043; --card:#0e1530;
    }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,PingFang TC,Noto Sans TC,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    h1{font-size:18px;margin:0}
    .page{max-width:1200px;margin:0 auto;padding:16px;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .actions{display:flex;gap:8px;align-items:end;flex-wrap:wrap;}
    label{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted)}
    input,select,button{background:#0b1430;color:var(--text);border:1px solid #243045;border-radius:10px;padding:8px 10px;outline:none}
    input::placeholder{color:#708090}
    button{cursor:pointer}
    button.primary{background:#0d2a52;border-color:#1e3a8a}
    button.danger{background:#3a0d16;border-color:#7f1d1d;color:#fecaca}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:12px;}
    .panel{background:var(--panel);border:1px solid #26324d;border-radius:16px;overflow:hidden}
    .panel-h{padding:10px 12px;border-bottom:1px solid #1f2a44;background:#0c132b;display:flex;align-items:center;justify-content:space-between}
    .panel-b{padding:8px 10px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0c132b;color:var(--muted);text-align:left;font-weight:600;padding:8px;border-bottom:1px solid #223052}
    tbody tr{background:var(--row);border-bottom:1px solid #15203b}
    tbody tr:hover{background:var(--rowHover)}
    td{padding:8px;vertical-align:top}
    .row{display:grid;grid-template-columns:140px 1fr;gap:8px;padding:6px 0;border-bottom:1px dashed #243152}
    .row:last-child{border-bottom:none}
    .k{color:var(--muted)}
    .v{color:#f8fafc;word-break:break-word}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a66;background:#0c1c44;color:#c7d2fe;font-size:12px}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center}
    .foot{color:var(--muted);padding:6px 4px}
    .toast{position:fixed;right:14px;bottom:14px;background:#10203f;border:1px solid #27406f;border-radius:12px;color:#e5f0ff;padding:10px 12px;opacity:0;transform:translateY(10px);transition:.25s}
    .toast.show{opacity:1;transform:none}
    .pill{border:1px solid #2b3c65;background:#0e1f49;color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
    .btn-del{border-color:#b91c1c;background:#3f0e12;color:#fecaca}
    .btn-del:focus-visible{box-shadow:0 0 0 3px rgba(248,113,113,.35)}
    .fullview .card{background:var(--card);border:1px solid #1f2a44;border-radius:14px;margin:10px 0;overflow:hidden}
    .fullview .card-h{padding:8px 10px;background:#0b1733;color:#93c5fd;border-bottom:1px solid #1f2a44}
    .fullview .card-b{padding:10px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width: 960px){
      .grid{grid-template-columns:1fr}
      .actions{width:100%}
      .right{flex-wrap:wrap}
    }
    dialog{border:none;border-radius:12px;padding:0;background:#0f172a;color:#e5e7eb}
    dialog .box{padding:16px 16px 12px}
    dialog::backdrop{background:rgba(0,0,0,.6)}
  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <h1>預約資料管理（Cloudinary）</h1>
      <div class="right">
        <button id="btnLogin">登入 / 變更 Token</button>
        <button id="btnLogout">登出</button>
      </div>
    </div>

    <div class="panel">
      <div class="panel-h">
        <div>搜尋</div>
        <div class="right">
          <button id="btnExport">匯出 CSV</button>
          <span class="pill" id="foot">準備就緒</span>
        </div>
      </div>
      <div class="panel-b actions">
        <label>關鍵字<input id="q" placeholder="姓名、電話、地址、類別…"></label>
        <label>起日<input id="start" type="date"></label>
        <label>迄日<input id="end" type="date"></label>
        <button class="primary" id="btnSearch">查詢</button>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="panel" aria-labelledby="tblh">
        <div class="panel-h" id="tblh">
          <div>清單</div>
        </div>
        <div class="panel-b">
          <table aria-label="預約清單">
            <thead><tr><th>建立時間</th><th>姓名 / 電話</th><th>服務類別</th><th>地址</th><th>操作</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="panel" aria-labelledby="detailh">
        <div class="panel-h" id="detailh">
          <div>詳情</div>
          <div class="right">
            <button id="btnDelete" class="btn-del" disabled>刪除此筆</button>
          </div>
        </div>
        <div class="panel-b fullview" id="detail">
          <p class="muted">點選左側任一列以檢視詳情</p>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <dialog id="dlgLogin" aria-labelledby="loginTitle" aria-modal="true">
    <div class="box">
      <h2 id="loginTitle" style="margin:0 0 8px;font-size:16px;">管理登入</h2>
      <p class="muted" style="margin:0 0 8px;">輸入後端頒發的 Admin Token（將以 <span class="pill">x-admin-token</span> 附加於請求）。</p>
      <label>Admin Token <input id="tokenInput" placeholder="paste your token"></label>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button id="btnCancel">取消</button>
        <button id="btnSave" class="primary">儲存</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ===== Config：依你的後端調整路徑 =====
  const API_LIST   = '/.netlify/functions/list-bookings';      // POST: {q,start,end,max}
  const API_DELETE = '/.netlify/functions/delete-booking';     // DELETE: ?public_id=...&resource_type=raw
  // =====================================

  // ===== State =====
  let ADMIN_TOKEN = localStorage.getItem('admin_token') || '';
  let CURRENT = null;
  let CURRENT_LIST = [];

  // ===== Utils =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function showToast(msg){
    const t = $("#toast"); t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 1800);
  }

  function fmtDate(s){
    try{
      const d = new Date(s);
      if (isNaN(d)) return s || "";
      return d.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
    }catch{ return s || ""; }
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // ---- Parse Cloudinary context → plain object ----
  function parseContext(ctx){
    // ctx 可為： {custom:{k:v}}, 或 "k=v|k2=v2"，或空
    const out = {};
    if (!ctx) return out;
    if (typeof ctx === 'string'){
      const parts = ctx.split('|');
      for (const seg of parts){
        const i = seg.indexOf('=');
        if (i < 0) continue;
        const k = seg.slice(0,i);
        let v = seg.slice(i+1);
        // 若是經 encodeURIComponent 的 JSON，嘗試還原
        try{
          const maybe = decodeURIComponent(v);
          if (maybe.startsWith('[') || maybe.startsWith('{')){
            try{ v = JSON.parse(maybe); }catch{ v = maybe; }
          }else{
            v = maybe;
          }
        }catch{}
        out[k] = v;
      }
      return out;
    }
    if (ctx.custom && typeof ctx.custom === 'object') return {...ctx.custom};
    return out;
  }

  // ---- Normalize to unified shape ----
  function normalizeContext(item){
    const ctx = parseContext(item.context || item.contexts || (item.metadata && item.metadata.context) || {});
    const meta = item.metadata || {};
    const get = (keys)=>{
      for(const k of keys){
        if (ctx[k] != null && String(ctx[k]).trim()!=="") return ctx[k];
        if (meta[k] != null && String(meta[k]).trim()!=="") return meta[k];
      }
      return "";
    };

    // 主類別：加入「服務類別」等別名
    const serviceMain = get([
      "service","service_category","service_item","select_service",
      "服務","服務類別","服務項目","服務類型","類別"
    ]);

    // 收集其他清洗服務（接受多種鍵名與格式）
    function collectOtherServices(){
      const raw = get(["extra_service","其他清洗服務","其他保養清洗"]);
      const set = new Set();
      const push = v => { const s = String(v).trim(); if (s) set.add(s); };
      if (Array.isArray(raw)) raw.forEach(push);
      else if (typeof raw === "string" && raw.trim()!==""){
        // 若是 JSON 陣列字串
        try{
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) parsed.forEach(push);
          else raw.split(/[,，、\s]+/).forEach(push);
        }catch{
          raw.split(/[,，、\s]+/).forEach(push);
        }
      }
      // 兼容個別旗標，例如 pipe_service=true 等（視情況擴充）
      const flags = [
        ["washing_machine","洗衣機清洗"],
        ["washer","洗衣機清洗"],
        ["pipe_service","自來水管清洗"],
        ["water_pipe","自來水管清洗"],
        ["tank_service","水塔清洗"],
        ["water_tank","水塔清洗"],
        ["range_hood","抽油煙機清洗"],
        ["solar_panel","太陽能板清洗"]
      ];
      for(const [key,label] of flags){
        const v = get([key,label]);
        if (v===true) push(label);
        if (typeof v==="string" && /^(true|1|yes|是|需要)$/i.test(v)) push(label);
      }
      return [...set];
    }
    const extras = collectOtherServices();
    const OTHER_ALIASES = new Set(["其他清洗服務","其他保養清洗"]);

    // 合成顯示文字
    let serviceDisplay = "";
    if (serviceMain && !OTHER_ALIASES.has(String(serviceMain))) {
      serviceDisplay = extras.length ? `${serviceMain}＋其他清洗服務（${extras.join("、")}）` : String(serviceMain);
    } else {
      serviceDisplay = extras.length ? `其他清洗服務（${extras.join("、")}）` : (serviceMain || "其他清洗服務");
    }

    return {
      created_at: item.created_at || item.createdAt || item.uploaded_at || "",
      public_id: item.public_id || item.asset_id || item.id || "",
      secure_url: item.secure_url || item.url || "",
      // 顯示用欄位：
      name: get(["name","customer_name","姓名"]),
      phone: get(["phone","phone_number","mobile","tel","電話"]),
      address: get(["address","地址"]),
      area: get(["area","city","region","地區"]),
      service: serviceDisplay,
      other_service_items: extras,
      note: get(["note","備註"]),
      // 原始：
      raw: { ctx, meta }
    };
  }

  // ---- Safe KV rendering using DOM API ----
  function kvNode(label, value){
    const row = document.createElement('div'); row.className='row';
    const k = document.createElement('div'); k.className='k'; k.textContent = label;
    const v = document.createElement('div'); v.className='v';
    const text = (value==null || String(value).trim()==="") ? "—" : String(value);
    v.textContent = text;
    row.append(k,v); return row;
  }
  function sectionCardNode(title, nodes){
    const card = document.createElement('div'); card.className='card';
    const h = document.createElement('div'); h.className='card-h'; h.textContent = title;
    const b = document.createElement('div'); b.className='card-b';
    nodes.forEach(n=>b.appendChild(n));
    card.append(h,b); return card;
  }

  function renderFull(item){
    const box = $("#detail");
    box.replaceChildren();
    if (!item){ box.appendChild(Object.assign(document.createElement('p'),{textContent:'尚未選擇資料',className:'muted'})); return; }
    const d = normalizeContext(item);

    const serviceCard = sectionCardNode("服務資訊",[
      kvNode("服務類別", d.service),
      kvNode("地址", d.address),
      kvNode("地區", d.area),
      kvNode("其他清洗服務項目", d.other_service_items && d.other_service_items.length ? d.other_service_items.join("、") : "—")
    ]);
    const contactCard = sectionCardNode("聯絡資訊",[
      kvNode("姓名", d.name),
      kvNode("電話", d.phone)
    ]);
    const miscCard = sectionCardNode("其他",[
      kvNode("備註", d.note),
      kvNode("建立時間", fmtDate(d.created_at)),
      kvNode("Cloudinary ID", d.public_id),
      kvNode("檔案連結", d.secure_url)
    ]);
    box.append(serviceCard, contactCard, miscCard);

    // 右上角刪除鈕
    $("#btnDelete").disabled = !d.public_id;
  }

  // ---- Table rendering ----
  function renderRows(list){
    const tb = $("#tbody"); tb.replaceChildren();
    if (!list || !list.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td'); td.colSpan = 5; td.className='muted'; td.textContent = "沒有資料";
      tr.appendChild(td); tb.appendChild(tr); return;
    }
    for (const it of list){
      const d = normalizeContext(it);
      const tr = document.createElement('tr');
      tr.tabIndex = 0; tr.setAttribute('role','button'); tr.setAttribute('aria-label', `查看 ${d.name||'此筆'} 詳情`);
      tr.addEventListener('click', ()=>{ CURRENT = it; renderFull(it); });
      tr.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); tr.click(); } });

      const td1 = document.createElement('td'); td1.textContent = fmtDate(d.created_at);
      const td2 = document.createElement('td'); td2.innerHTML = `<div>${escapeHtml(d.name||'—')}</div><div class="muted" style="font-size:12px">${escapeHtml(d.phone||'')}</div>`;
      const td3 = document.createElement('td'); td3.textContent = d.service || '—';
      const td4 = document.createElement('td'); td4.textContent = d.address || '—';

      const td5 = document.createElement('td');
      const btn = document.createElement('button'); btn.textContent='刪除'; btn.className='btn-del'; btn.type='button';
      btn.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        if (!confirm(`確定要刪除這筆資料？（${d.name||d.public_id}）`)) return;
        try{
          await deleteBooking(it.public_id, 'raw');
          tr.remove();
          if (CURRENT && CURRENT.public_id === it.public_id){ CURRENT = null; renderFull(null); }
          showToast("已刪除");
        }catch(e){
          showToast("刪除失敗：" + e.message);
        }
      });
      td5.appendChild(btn);

      tr.append(td1,td2,td3,td4,td5);
      tb.appendChild(tr);
    }
  }

  // ---- API helpers ----
  async function authedFetch(url, opts={}){
    const headers = Object.assign({}, opts.headers||{});
    if (ADMIN_TOKEN) headers['x-admin-token'] = ADMIN_TOKEN;
    const r = await fetch(url, Object.assign({}, opts, { headers }));
    if (r.status === 401){
      throw new Error("未授權（401）。請先登入。");
    }
    return r;
  }

  async function listBookings(payload){
    const r = await authedFetch(API_LIST, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload||{})
    });
    if (!r.ok) throw new Error(`查詢失敗：${r.status}`);
    return r.json();
  }

  async function deleteBooking(public_id, resource_type){
    const url = new URL(API_DELETE, location.origin);
    url.searchParams.set('public_id', public_id);
    if (resource_type) url.searchParams.set('resource_type', resource_type);
    const r = await authedFetch(url.toString(), { method:'DELETE' });
    if (!r.ok){
      let msg = `刪除失敗：${r.status}`;
      try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch{}
      throw new Error(msg);
    }
    return true;
  }

  // ---- CSV ----
  function exportCSV(list){
    const rows = [["建立時間","姓名","電話","服務類別","地址","地區","其他清洗服務項目","備註","Cloudinary ID","檔案連結"]];
    for(const it of list){
      const d = normalizeContext(it);
      rows.push([
        fmtDate(d.created_at),
        d.name||"",
        d.phone||"",
        d.service||"",
        d.address||"",
        d.area||"",
        (d.other_service_items||[]).join("、"),
        (d.note||"").replace(/\r?\n/g," "),
        d.public_id||"",
        d.secure_url||""
      ]);
    }
    const csv = rows.map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\r\n");
    const bom = "\uFEFF"; // Excel UTF-8
    const blob = new Blob([bom + csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `bookings_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(a.href);
  }

  // ---- Events ----
  $("#btnLogin").addEventListener('click', ()=>{
    const dlg = $("#dlgLogin");
    $("#tokenInput").value = ADMIN_TOKEN;
    dlg.showModal();
    $("#tokenInput").focus();
  });
  $("#btnCancel").addEventListener('click', ()=> $("#dlgLogin").close());
  $("#btnSave").addEventListener('click', ()=>{
    ADMIN_TOKEN = $("#tokenInput").value.trim();
    if (ADMIN_TOKEN) localStorage.setItem('admin_token', ADMIN_TOKEN);
    else localStorage.removeItem('admin_token');
    $("#dlgLogin").close();
    showToast("已儲存 Token");
  });
  $("#btnLogout").addEventListener('click', ()=>{
    localStorage.removeItem('admin_token'); ADMIN_TOKEN=''; showToast("已登出");
  });

  $("#btnSearch").addEventListener('click', async ()=>{
    const foot = $("#foot");
    const q = $("#q").value.trim();
    const start = $("#start").value;
    const end = $("#end").value;
    const payload = { q, start, end, max: 50 };
    try{
      $("#btnSearch").disabled = true; foot.textContent = "查詢中…";
      const data = await listBookings(payload);
      const list = data.list || data.resources || data.items || [];
      CURRENT_LIST = list;
      renderRows(list);
      $("#foot").textContent = `共 ${list.length} 筆`;
    }catch(e){
      $("#foot").textContent = e.message || "查詢錯誤";
    }finally{
      $("#btnSearch").disabled = false;
    }
  });

  $("#btnExport").addEventListener('click', ()=>{
    if (!CURRENT_LIST.length){ showToast("目前沒有可匯出的資料"); return; }
    exportCSV(CURRENT_LIST);
  });

  $("#btnDelete").addEventListener('click', async ()=>{
    if (!CURRENT || !CURRENT.public_id) return;
    if (!confirm("確定要刪除這筆資料？")) return;
    try{
      await deleteBooking(CURRENT.public_id, 'raw');
      showToast("已刪除");
      // 從列表移除
      CURRENT_LIST = CURRENT_LIST.filter(x=>x.public_id !== CURRENT.public_id);
      renderRows(CURRENT_LIST);
      CURRENT = null; renderFull(null);
    }catch(e){
      showToast(e.message || "刪除失敗");
    }
  });

  // 自動聚焦關鍵字輸入
  $("#q").focus();
})();
</script>
</body>
</html>
