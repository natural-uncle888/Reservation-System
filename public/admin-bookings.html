<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>預約資料管理（Cloudinary）</title>
<link href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" rel="icon" type="image/png"/>
<style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;margin:0;background:#f8fafc;color:#0f172a}
    header{padding:26px 20px 8px}
    h1{margin:0 0 4px;font-size:22px}
    .sub{color:#64748b;font-size:13px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 20px 40px}
    .row{display:flex;gap:10px;align-items:end;margin:10px 0 14px;flex-wrap:wrap}
    .input{display:flex;flex-direction:column;gap:6px}
    .input input{height:38px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;min-width:220px}
    .btn{height:38px;padding:0 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn.primary{background:#0f172a;border-color:#0f172a;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    th,td{padding:12px 14px;font-size:14px;border-bottom:1px solid #e5e7eb}
    th{background:#f9fafb;color:#374151;text-align:left;position:sticky;top:0}
    tr:hover{background:#f6f9ff;cursor:pointer}
    .grid{display:grid;grid-template-columns: 1fr 380px;gap:16px;align-items:start}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .panel h3{margin:0 0 10px}
    .fullview-wrap{display:flex;flex-direction:column;gap:12px}
    .card.fullview{border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card.fullview .card-h{padding:10px 12px;font-weight:600;color:#3b82f6}
    .card.fullview .card-b{padding:8px 12px 12px}
    .card.fullview .row{display:grid;grid-template-columns:160px 1fr;padding:6px 0;border-bottom:1px dotted #eef2f7}
    .card.fullview .row:last-child{border-bottom:0}
    .card.fullview .k{color:#6b7280}
    .card.fullview .v{color:#111827;white-space:pre-wrap}
    .email-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000}
    .email-dialog{width:min(720px,92vw);background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    .email-dialog h3{margin:0 0 10px}
    .email-dialog textarea{width:100%;height:320px;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .email-dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  
/* === Admin Login Modal === */
.login-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:999}
.login-dialog{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);width:min(520px,92vw);padding:18px 18px 16px;border:1px solid #e5e7eb}
.login-h{margin:2px 4px 2px;font-size:20px;font-weight:700;color:#111827}
.login-sub{margin:0 4px 14px;font-size:14px;color:#6b7280}
.login-field{display:flex;flex-direction:column;gap:6px;margin:10px 4px}
.login-label{font-size:13px;color:#374151}
.login-input{height:40px;border-radius:12px;border:1px solid #e5e7eb;padding:8px 12px;background:#fff;outline:none}
.login-input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.login-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.btn-secondary{background:#f3f4f6;border:1px solid #e5e7eb;color:#111827;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn-primary{background:#0f172a;color:#fff;border:1px solid #111827;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}
.login-error{margin:6px 4px 0;color:#b91c1c;font-size:13px;display:none}

/* === Login Dialog 輸入框在手機時不全螢幕 === */
@media (max-width: 640px){
  .login-dialog{
    max-width: 360px;
    width: calc(100% - 32px);
    margin: 0 auto;              /* 置中 */
    border-radius: 16px;
  }
  .login-input input{
    width: 100%;
    box-sizing: border-box;
  }
}


/* === 頁面標題與說明置中 === */
header {
  text-align: center;
}

header h1 {
  text-align: center;
  margin-bottom: 4px;
}

header .sub {
  text-align: center;
  display: block;
  margin-bottom: 12px;
  color: #64748b;
}


/* === 手機字體與可點性優化 === */
@media (max-width: 640px){
  html { font-size: 17px; }          /* 提升整體字級 */
  body { line-height: 1.6; }

  /* 標題與副標 */
  header h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  header .sub { font-size: 15px; line-height: 1.4; }

  /* 表單輸入與按鈕 */
  .input input { font-size: 16px; height: 48px; padding: 0 12px; }
  .btn, .btn.primary { font-size: 16px; height: 48px; }

  /* 表格可讀性 */
  th { font-size: 15px; font-weight: 600; }
  td { font-size: 15px; line-height: 1.5; }
  tr { min-height: 48px; }

  /* 詳情面板 key/value */
  .card.fullview .k { font-size: 14px; }
  .card.fullview .v { font-size: 16px; }
}


/* === 隱藏詳情面板內容 === */
.card.fullview .card-b {
  display: none;    /* 隱藏內容區 */
}

.card.fullview .card-h::after {
  content: '';      
}

</style>
<style>
/* ====== Mobile-first: 通用可用性 ====== */
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}
*{ -webkit-tap-highlight-color: transparent; }
button, input, textarea, select{ font-size:16px; } /* iOS 避免焦點時自動放大 */
body{ overscroll-behavior-y: none; }

/* ====== 版面：改為小螢幕單欄、放大可點區域 ====== */
@media (max-width: 1024px){
  .wrap{ padding:0 16px 24px; }
  .grid{ grid-template-columns: 1fr !important; gap: 12px; }
  header{ padding: calc(16px + var(--safe-top)) 16px 6px; }
  h1{ font-size:20px; }
  .sub{ font-size:13px; }
  .row{ gap:8px; align-items: stretch; }
  .input input{ min-width:0; width:100%; height:44px; }
  .btn, .btn.primary{ height:44px; padding:0 16px; border-radius:12px; }
  .panel{ padding:12px; border-radius:12px; }
}

/* ====== 表格可橫向捲動 ====== */
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:14px; }
.table-wrap > table{ min-width:720px; }

@media (max-width: 640px){
  th, td{ padding:10px 12px; font-size:14px; }
  tr:hover{ background:#f6f9ff; }
  th{ top:0; }
}

/* 鍵盤可達性：列可聚焦（配合JS加 tabindex） */
tr:focus-within{ outline:2px solid #93c5fd; outline-offset:-2px; background:#f0f7ff; }

/* ====== 卡片（詳情）在手機更易讀 ====== */
@media (max-width: 640px){
  .card.fullview{ border-radius:12px; }
  .card.fullview .card-h{ padding:10px 12px; font-size:15px; }
  .card.fullview .card-b{ padding:8px 12px 12px; }
  .card.fullview .row{ grid-template-columns: 1fr !important; gap: 2px; padding:8px 0; }
  .card.fullview .k{ font-size:13px; color:#6b7280; }
  .card.fullview .v{ font-size:15px; }
}

/* ====== 模態：手機全螢幕、好關閉、鍵盤不遮擋 ====== */
@media (max-width: 640px){
  .login-dialog,
  .email-dialog{
    width: 100vw !important;
    max-width: 100vw !important;
    height: auto;
    max-height: calc(100dvh - 16px - var(--safe-top) - var(--safe-bottom));
    margin: 0;
    border-radius: 16px 16px 0 0;
    padding-bottom: max(16px, var(--safe-bottom));
  }
  .email-dialog textarea{ height: 40dvh; }
}

/* ====== 觸控目標大小與狀態 ====== */
.btn, .btn.primary, .btn-primary, .btn-secondary{
  min-width: 44px; min-height: 44px;
}
.btn:active, .btn-primary:active, .btn-secondary:active{ transform: translateY(1px); }

/* ====== iOS 背景鎖定（配合JS在開啟模態時加 body--modal-open） ====== */
body.body--modal-open{ height:100dvh; overflow:hidden; }
</style>
<style>.card.fullview .card-b{display:block !important;}</style>
<script>
    window.ADMIN_TOKEN = "my_super_secret_token_2025";
  </script>
</head>
<body>
<div aria-modal="true" class="login-backdrop" id="loginModal" role="dialog">
<div class="login-dialog">
<div class="login-h">管理登入</div>
<div class="login-sub">請輸入帳號與密碼以檢視資料。</div>
<div class="login-field">
<label class="login-label" for="login-username">帳號</label>
<input autocomplete="username" class="login-input" id="login-username" placeholder="admin" type="text"/>
</div>
<div class="login-field">
<label class="login-label" for="login-password">密碼</label>
<input autocomplete="current-password" class="login-input" id="login-password" placeholder="••••••••" type="password"/>
</div>
<div class="login-error" id="login-error">登入失敗，請確認帳號密碼。</div>
<div class="login-actions">
<button class="btn-secondary" id="login-clear" type="button">清除</button>
<button class="btn-primary" id="login-submit" type="button">登入</button>
</div>
</div>
</div>
<header>
<h1>預約資料管理（Cloudinary）</h1>
<div class="sub">僅展示 姓名 / 電話 / 服務 / 建立時間；詳情面板可直接「查看完整內容」或「貼上信件內容並回填」。</div>
</header>
<div class="wrap">
<div class="row">
<label class="input"><span>關鍵字</span><input id="q" placeholder="姓名、電話、public_id…"/></label>
<label class="input"><span>起始日期</span><input id="start" placeholder="yyyy/mm/dd"/></label>
<label class="input"><span>結束日期</span><input id="end" placeholder="yyyy/mm/dd"/></label>
<button class="btn primary" id="btnSearch">查詢</button>
<button class="btn" id="btnCsv">匯出 CSV</button>
</div>
<div class="grid">
<div>
<div class="table-wrap"><table id="tbl">
<thead><tr><th>姓名</th><th>電話</th><th>服務</th><th>建立時間</th></tr></thead>
<tbody></tbody>
</table></div>
<div id="foot" style="margin-top:8px;color:#6b7280"></div>
</div>
<div class="panel">
<div id="preview" style="min-height:120px;"></div>
<div style="margin-top:8px;display:flex;gap:8px">
<button class="btn" id="btnPaste">貼上信件內容（僅顯示）</button>
</div>
</div>
</div>
</div>
<div class="email-modal" id="emailModal">
<div class="email-dialog">
<h3>貼上信件內容 → 解析並回填</h3>
<div style="color:#6b7280;font-size:13px;margin-bottom:6px">請從 Gmail 直接複製可見文字貼上；會自動解析欄位並同步到 Cloudinary context。</div>
<textarea id="emailPaste"></textarea>
<div class="actions">
<button class="btn" id="emailCancel">取消</button>
<button class="btn primary" id="emailApply">解析並回填</button>
</div>
<div id="emailMsg" style="color:#2563eb;font-size:13px;margin-top:6px"></div>
</div>
</div>
<script>
const API_LIST = "/.netlify/functions/list-bookings";
const API_LOGIN = "/.netlify/functions/auth-login";
const API_UPDATE_CTX = "/.netlify/functions/update-booking-context";
let ADMIN_TOKEN = localStorage.getItem("admin_token") || "";
let CURRENT_ITEM = null;
let CURRENT_LIST = [];
const $ = (s)=>document.querySelector(s);

function needLogin(){ return !ADMIN_TOKEN; }

async function login(){
  return new Promise((resolve)=>{
    const modal = document.getElementById('loginModal');
    const uEl = document.getElementById('login-username');
    const pEl = document.getElementById('login-password');
    const err = document.getElementById('login-error');
    const btnSubmit = document.getElementById('login-submit');
    const btnClear = document.getElementById('login-clear');
    // init
    err.style.display = 'none';
    uEl.value = '';
    pEl.value = '';
    modal.style.display = 'flex';
    uEl.focus();

    const doSubmit = async ()=>{
      btnSubmit.disabled = true;
      err.style.display = 'none';
      const u = uEl.value.trim();
      const p = pEl.value;
      if(!u || !p){ err.textContent = "請輸入帳號與密碼"; err.style.display='block'; btnSubmit.disabled=false; return; }
      try{
        const r = await fetch(API_LOGIN, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username:u, password:p }) });
        const j = await r.json();
        if (!r.ok){ err.textContent = j.message || j.error || "登入失敗"; err.style.display='block'; btnSubmit.disabled=false; return; }
        ADMIN_TOKEN = j.token; localStorage.setItem("admin_token", ADMIN_TOKEN);
        modal.style.display = 'none';
        resolve(true);
      }catch(e){
        err.textContent = "網路錯誤，請稍後重試"; err.style.display='block';
        btnSubmit.disabled = false;
      }
    };

    btnSubmit.onclick = doSubmit;
    btnClear.onclick = ()=>{ uEl.value=''; pEl.value=''; uEl.focus(); };
    pEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSubmit(); });
    uEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') pEl.focus(); });
  });
}
function fmtDate(d){ return new Date(d).toLocaleString(); }
function pick(obj, keys, fb=""){ for(const k of keys){ if(obj && obj[k]!=null && String(obj[k]).trim()!=="") return String(obj[k]).trim(); } return fb; }


function decodeArray(val){
  try {
    const decoded = decodeURIComponent(val || "");
    const parsed = JSON.parse(decoded);
    if (Array.isArray(parsed)) return parsed.join(", ");
    return parsed;
  } catch (e){
    return val;
  }
}


function normalizeContext(item){
  const c = (item.context && item.context.custom) ? item.context.custom : (item.context || {});
  const m = item.metadata || {};
  const get = (names, fb="") => pick(c, names, pick(m, names, fb));
  return {
    bulk_notes: get(["bulk_notes", "大量清洗備註"]),
    group_notes: get(["group_notes", "團購備註"]),
    service_description: get(["service_description", "其他服務說明"]),
    contact_method: get(["contact_method"]),
    social_name: get(["social_name"]),
    housing_type: get(["housing_type"]),
    contact_time_preference: decodeArray(get(["contact_time_preference"])),
    washer_count: get(["washer_count"]),
    washer_floor: decodeArray(get(["washer_floor"])),
    tank_count: get(["tank_count"]),
    pipe_service: get(["pipe_service"]),
    pipe_reason: decodeArray(get(["pipe_reason"])),
    name: get(["name","customer_name","fullname","姓名"]),
    phone: get(["phone","phone_number","mobile","tel","電話"]),
    service: get(["service","service_category","service_item","select_service","服務"]),
    address: get(["address","地址"]),
    brand: decodeArray(get(["ac_brand","brand","冷氣品牌"])),
    ac_type: get(["ac_type","冷氣類型"]),
    count: get(["ac_count","count","quantity","清洗數量"]),
    floor: decodeArray(get(["indoor_floor","floor","樓層","室內機所在樓層"])),
    is_inverter: get(["ac_transformer_series","是否為「變形金剛系列」冷氣機型？"]),
    antifungus: get(["anti_mold","antifungus","冷氣防霉抗菌處理"]),
    ozone: get(["ozone","臭氧殺菌消毒"]),
    extra_service: get(["extra_service","其他清洗服務"]),
    line_id: get(["line_or_fb","line_id","LINE","聯絡Line"]),
    fb_name: get(["social_name","fb_name","facebook","FB","LINE & Facebook 姓名"]),
    timeslot: get(["timeslot","預約時段"]),
    date: get(["date","預約日期"]),
    note: get(["note","備註"]),
  };
}

function kv(label, value){ const s=(v)=>(v==null||String(v).trim()==="")?"—":String(v); return `<div class="row"><div class="k">${label}</div><div class="v">${s(value)}</div></div>`; }
function sectionCard(title, rowsHtml){ return `<div class="card fullview"><div class="card-h">${title}</div><div class="card-b">${rowsHtml}</div></div>`; }
function renderFullContent(item, mount){
  const data = normalizeContext(item);
  const blocks = [];
  
  
if (data.service === "冷氣清洗") {
  blocks.push(sectionCard("服務資訊",
    kv("服務類別", data.service) +
    kv("冷氣類型", data.ac_type) +
    kv("清洗數量", data.count) +
    kv("室內機所在樓層", data.floor) +
    kv("冷氣品牌", data.brand) +
    kv("是否為「變形金剛系列」冷氣機型？", data.is_inverter)
  ));
} 
else {
  blocks.push(sectionCard("服務資訊",
    kv("服務類別", data.service)
  ));
}

if (data.service === "團購預約清洗" || data.service === "大量清洗需求") {
  let descTitle = (data.service === "團購預約清洗") ? "團購預約說明" : "大量需求說明";
  blocks.push(sectionCard(descTitle, kv("內容", data.group_notes || data.bulk_notes)));
}


if (data.service_description) {
  blocks.push(sectionCard("其他服務說明", kv("內容", data.service_description)));
}


  blocks.push(sectionCard("防霉・消毒｜加購服務專區", kv("冷氣防霉抗菌處理", data.antifungus ? "需要" : "不需要") + kv("臭氧殺菌消毒", data.ozone ? "需要" : "不需要")));
  blocks.push(sectionCard("其他清洗服務",
  kv("直立式洗衣機清洗（台數）", data.washer_count) +
  kv("洗衣機樓層", data.washer_floor) +
  kv("家用水塔清洗（顆數）", data.tank_count) +
  kv("自來水管清洗戶型方案", data.pipe_service) +
  kv("自來水管清洗原因", data.pipe_reason)
));
  blocks.push(sectionCard("聯繫資料",
    kv("聯絡人", data.name) +
    kv("聯絡電話", data.phone) +
    kv("與我們聯繫方式", data.contact_method) +
    kv("LINE 或 Facebook 名稱", (data.contact_method?.includes("LINE") || data.contact_method?.includes("Facebook")) ? data.social_name : "")  +
    kv("居住地型態", data.housing_type) +
    kv("方便聯繫時間", data.contact_time_preference) +
    kv("地址", data.address) +
    kv("可安排時段", decodeArray(data.timeslot)) +
    kv("備註", data.note) +
    kv("建立時間", new Date(item.created_at).toLocaleString())
  ));
  mount.innerHTML = `<div class="fullview-wrap">${blocks.join("")}</div>`;
}

async function doSearch(){
  const payload = { q: $("#q").value.trim(), start: $("#start").value.trim(), end: $("#end").value.trim(), max: 50 };
  const r = await fetch(API_LIST, { method:"POST", headers:{ "Content-Type":"application/json", "x-admin-token": ADMIN_TOKEN }, body: JSON.stringify(payload) });
  if (r.status === 401){ ADMIN_TOKEN=""; localStorage.removeItem("admin_token"); if(await login()) return doSearch(); return; }
  const data = await r.json();
  const list = data.resources || data.items || [];
  CURRENT_LIST = list;
  const tbody = $("#tbl tbody"); tbody.innerHTML = "";
  for (const it of list){
    const ctx = normalizeContext(it);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${ctx.name || "(未填)"}</td><td>${ctx.phone||""}</td><td>${ctx.service||""}</td><td>${fmtDate(it.created_at)}<button onclick="deleteBooking(item.public_id)" title="刪除" style="margin-left:8px;color:red;">🗑</button></td>`;
    tr.onclick = ()=> openDetails(it);
    tbody.appendChild(tr);
  }
  $("#foot").textContent = `共 ${data.total_count ?? list.length} 筆`;
}

function openDetails(item){
  CURRENT_ITEM = item;
  const pv = $("#preview");
  if (pv) pv.innerHTML = "";
  // 點選左側列時，顯示 Cloudinary 詳細內容
  renderFullContent(item, $("#preview"));
}

$("#btnSearch").onclick = () => doSearch();
$("#btnCsv").onclick = () => {
  const rows = [["姓名","電話","服務","建立時間"]];
  for (const it of CURRENT_LIST){
    const c = normalizeContext(it);
    rows.push([c.name||"", c.phone||"", c.service||"", fmtDate(it.created_at)]);
  }
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "bookings.csv"; a.click(); URL.revokeObjectURL(a.href);
};

// paste-from-email modal
$("#btnPaste").onclick = ()=>{
  if (!CURRENT_ITEM) { alert("請先點列表選擇一筆資料"); return; }
  $("#emailPaste").value = ""; $("#emailMsg").textContent=""; $("#emailModal").style.display="flex";
};
$("#emailCancel").onclick = ()=> $("#emailModal").style.display="none";
function escapeHtml(s){
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

$("#emailApply").onclick = async ()=>{
  const text = $("#emailPaste").value;
  const msg = $("#emailMsg");
  const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const kvs = {};
  for (const ln of lines){
    let m = ln.match(/^(.+?)[:：]\s*(.+)$/);
    if (!m) m = ln.match(/^(.+?)\s+(.+)$/);
    if (m){ kvs[m[1].trim()] = m[2].trim(); }
  }
  const pick = (obj, keys)=>{ for(const k of keys){ if(obj[k]!=null && String(obj[k]).trim()!=="") return String(obj[k]).trim(); } return ""; };
  const ctx = {
    name: pick(kvs, ["聯絡人","姓名","name"]),
    phone: pick(kvs, ["聯絡電話","電話","phone"]),
    service: pick(kvs, ["服務類別","服務","service"]),
    address: pick(kvs, ["地址","住址","address"]),
    ac_type: pick(kvs, ["冷氣類型","ac_type"]),
    count: pick(kvs, ["清洗數量","數量","count"]),
    floor: pick(kvs, ["室內機所在樓層","樓層","floor"]),
    brand: pick(kvs, ["冷氣品牌","brand"]),
    is_inverter: pick(kvs, ["是否為變頻機型系列","變頻","is_inverter"]),
    antifungus: pick(kvs, ["冷氣防霉抗菌處理","antifungus"]),
    ozone: pick(kvs, ["臭氧殺菌消毒","ozone"]),
    extra_service: pick(kvs, ["其他清洗服務","extra_service"]),
    line_id: pick(kvs, ["LINE","LINE / Facebook","line_id"]),
    fb_name: pick(kvs, ["LINE & Facebook 姓名","facebook","fb_name"]),
    date: pick(kvs, ["預約日期","date"]),
    timeslot: pick(kvs, ["預約時段","時段","timeslot"]),
    note: pick(kvs, ["備註","note"]),
    source: pick(kvs, ["來源","subject","page_title"]),
  };
  Object.keys(ctx).forEach(k=>{ if(!ctx[k]) delete ctx[k]; });

  if (!text || !lines.length){
    msg.textContent = "沒有讀到可解析的文字，請確認貼上的是純文字內容（僅顯示，不寫回）";
    return;
  }

  // 只顯示在詳情面板（不寫回）
  const pv = $("#preview");
const toRows = (o)=> Object.keys(o).length
    ? Object.entries(o).map(([k,v]) => `<div class="row"><div class="k">${k}</div><div class="v">${escapeHtml(v)}</div></div>`).join("")
    : `<div class="row"><div class="k">解析結果</div><div class="v">（未偵測到可用欄位）</div></div>`;

  const rawCard = `
    <div class="card fullview">
      <div class="card-h">Email 原始內容（僅顯示）</div>
      <div class="card-b">
        <div class="row"><div class="k">貼上文字</div><div class="v" style="white-space:pre-wrap">${escapeHtml(text)}</div></div>
      </div>
    </div>`;

  const parsedCard = `
    <div class="card fullview">
      <div class="card-h">解析結果（未寫回）</div>
      <div class="card-b">${toRows(ctx)}</div>
    </div>`;

  pv.innerHTML = `<div class="fullview-wrap">${rawCard}${parsedCard}</div>`;

  // 提示＋關閉視窗
  msg.textContent = "已顯示在右側詳情（未寫回）";
  $("#emailModal").style.display = "none";
};

(async ()=>{ if (needLogin()){ const ok = await login(); if(!ok) return; } doSearch(); })();
</script>
<script>
  // 1) 模態開關時鎖定背景捲動
  function lockScrollForModal(open){
    document.body.classList.toggle('body--modal-open', !!open);
  }

  // 2) 表格列支援 Enter/Space 觸發 click（無障礙）
  document.addEventListener('keydown', (e)=>{
    const tr = e.target && e.target.closest && e.target.closest('tr[tabindex="0"]');
    if(!tr) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      tr.click();
    }
  });

  // 3) 自動為表格列加 tabindex="0"，初次與動態新增都會套用
  function enhanceRowsTabIndex(){
    document.querySelectorAll('table#tbl tbody tr').forEach(tr=>{
      if(!tr.hasAttribute('tabindex')) tr.setAttribute('tabindex','0');
    });
  }
  const mo = new MutationObserver(enhanceRowsTabIndex);
  window.addEventListener('DOMContentLoaded', ()=>{
    enhanceRowsTabIndex();
    const tbody = document.querySelector('table#tbl tbody');
    if(tbody) mo.observe(tbody, {childList:true, subtree:true});
  });

  // 4) iOS：輸入框聚焦時，避免被鍵盤遮住
  const autoScrollInputs = ['INPUT','TEXTAREA'];
  document.addEventListener('focusin', (e)=>{
    if(autoScrollInputs.includes(e.target.tagName)){
      setTimeout(()=>{ e.target.scrollIntoView({block:'center'}); }, 100);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll("button");
  buttons.forEach(btn => {
    if (btn.textContent.includes("貼上信件內容（僅顯示）")) {
      btn.style.display = "none";
    }
  });
});
</script>
<script>
      async function deleteBooking(publicId) {
        if (!publicId) return alert("無法取得 public_id");
        if (!confirm("是否確定要刪除這筆訂單？")) return;

        try {
          const response = await fetch(
            `/.netlify/functions/delete-booking?public_id=${encodeURIComponent(publicId)}`,
            {
              method: "DELETE",
              headers: {
                "x-admin-token": window.ADMIN_TOKEN
              }
            }
          );

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "刪除失敗");

          alert("刪除成功！");
          location.reload();
        } catch (err) {
          alert("❌ 刪除失敗：" + err.message);
        }
      }
    </script><script>
    async function deleteBooking(publicId) {
      if (!publicId) return alert("無法取得 public_id");
      if (!confirm("是否確定要刪除這筆訂單？")) return;

      try {
        const response = await fetch(
          `/.netlify/functions/delete-booking?public_id=${encodeURIComponent(publicId)}`,
          {
            method: "DELETE",
            headers: {
              "x-admin-token": window.ADMIN_TOKEN
            }
          }
        );

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "刪除失敗");

        alert("刪除成功！");
        location.reload();
      } catch (err) {
        alert("❌ 刪除失敗：" + err.message);
      }
    }
    </script></body>
</html>
