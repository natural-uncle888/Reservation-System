<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>預約資料管理（Cloudinary）</title>
  <link rel="stylesheet" href="/mobile.css" />
  <style>
    :root{ --gap:12px; --radius:12px; --bg:#f5f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px}
    .sub{font-size:12px;color:var(--muted);margin-bottom:18px}
    .toolbar{display:grid;grid-template-columns:1.5fr 1fr 1fr auto auto;gap:var(--gap);align-items:end;margin-bottom:16px}
    .toolbar label{font-size:12px;color:#374151;margin-bottom:6px;display:block}
    .toolbar input,.toolbar select,.toolbar button{padding:10px 12px;font-size:14px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .toolbar input::placeholder{color:#9ca3af}
    .toolbar .actions{display:flex;gap:8px}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .thead{display:grid;grid-template-columns:2fr 1.6fr 1.6fr 1.3fr;gap:0}
    .thead .th{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:600;font-size:14px;color:#374151}
    .tbody{max-height:62vh;overflow:auto;display:block}
    .row{display:grid;grid-template-columns:2fr 1.6fr 1.6fr 1.3fr;border-bottom:1px solid var(--line);}
    .row button{all:unset;display:contents}
    .cell{padding:12px 14px;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .empty{padding:24px 14px;color:var(--muted);font-size:14px}
    .right{padding:12px}
    .panel{padding:12px;border:1px dashed var(--line);border-radius:10px;background:#fafafa;height:62vh;overflow:auto}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;border:1px solid #e0e7ff}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px;margin:8px 0}
    .kv .k{color:#374151}
    .kv .v{color:#111827;word-break:break-all}
    details{margin-top:10px}
    summary{cursor:pointer;color:#2563eb}
    .login{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px}
    .login-inner{background:#fff;border-radius:14px;border:1px solid var(--line);width:min(420px,90vw);padding:18px}
    .login h2{margin:0 0 8px;font-size:18px}
    .login .row{display:block}
    .login label{display:block;font-size:12px;color:#374151;margin-top:10px;margin-bottom:6px}
    .login input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
    .login .btns{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
    .btn{background:#111827;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--line)}
    .status{font-size:12px;color:#ef4444;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>預約資料管理（Cloudinary）</h1>
    <div class="sub">檢索示例：姓名／電話／服務／建立時間；詳情面板可查看「context / metadata」。</div>

    <div class="toolbar">
      <div>
        <label>關鍵字</label>
        <input id="q" type="search" placeholder="姓名、電話、public_id…" />
      </div>
      <div>
        <label>起始日期</label>
        <input id="from" type="date" />
      </div>
      <div>
        <label>結束日期</label>
        <input id="to" type="date" />
      </div>
      <div class="actions">
        <button class="btn" id="btn-search">查詢</button>
        <button class="btn secondary" id="btn-csv">匯出 CSV</button>
      </div>
      <div class="actions">
        <button class="btn secondary" id="btn-prev" disabled>上一頁</button>
        <button class="btn secondary" id="btn-next" disabled>下一頁</button>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="thead">
          <div class="th">姓名</div>
          <div class="th">電話</div>
          <div class="th">服務</div>
          <div class="th">建立時間</div>
        </div>
        <div id="list" class="tbody">
          <div class="empty">尚無資料，請先搜尋。</div>
        </div>
      </div>

      <div class="card right">
        <div class="panel">
          <div class="title"><strong>詳情</strong><span class="badge" id="detail-type">—</span></div>
          <div class="kv"><div class="k">姓名</div><div class="v" id="d-name">—</div></div>
          <div class="kv"><div class="k">電話</div><div class="v" id="d-phone">—</div></div>
          <div class="kv"><div class="k">服務</div><div class="v" id="d-service">—</div></div>
          <div class="kv"><div class="k">建立時間</div><div class="v" id="d-time">—</div></div>
          <div class="kv"><div class="k">大小</div><div class="v" id="d-bytes">—</div></div>
          <div class="kv"><div class="k">連結</div><div class="v"><a id="d-url" href="#" target="_blank" rel="noreferrer">—</a></div></div>

          <details>
            <summary>context / metadata</summary>
            <div id="d-raw" style="margin-top:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;font-size:12px;white-space:pre-wrap;"></div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="login" id="login">
    <div class="login-inner">
      <h2>管理登入</h2>
      <p class="muted" style="margin:0 0 6px">請輸入帳號與密碼以檢視資料。</p>
      <label>帳號</label>
      <input id="lg-user" autocomplete="username" placeholder="admin" />
      <label>密碼</label>
      <input id="lg-pass" type="password" autocomplete="current-password" placeholder="••••••••" />
      <div class="btns">
        <span class="status" id="lg-msg"></span>
        <button class="btn secondary" id="lg-clear">清除</button>
        <button class="btn" id="lg-submit">登入</button>
      </div>
    </div>
  </div>

<script>
const API = "/.netlify/functions/list-bookings";
const LOGIN_API = "/.netlify/functions/auth-login";
const LS_KEY = "ADMIN_TOKEN";
let LAST_CURSOR = null;
let PREV_STACK = []; // for prev

function nb(v){ return (v==null?"":String(v)).trim(); }
function bytes(x){ if(!x && x!==0) return "—"; const u=["B","KB","MB","GB"]; let i=0; let n=Number(x); while(n>=1024&&i<u.length-1){ n/=1024; i++; } return n.toFixed( (i?1:0) )+" "+u[i]; }
function ctxGet(item, key){ try{ return (item.context && item.context.custom && item.context.custom[key]) || ""; }catch{ return ""; } }
function csvEsc(s){ const t=String(s??""); return /[",\n]/.test(t) ? `"${t.replace(/"/g,'""')}"` : t; }

function adminToken(){ return localStorage.getItem(LS_KEY)||""; }
function needLogin(){ const t=adminToken(); return !t; }
function showLogin(){ document.getElementById("login").style.display="flex"; }
function hideLogin(){ document.getElementById("login").style.display="none"; }

async function doLogin(){
  const u=document.getElementById('lg-user').value.trim();
  const p=document.getElementById('lg-pass').value.trim();
  document.getElementById('lg-msg').textContent = "";
  try{
    const r = await fetch(LOGIN_API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username:u, password:p })
    });
    if(!r.ok){
      const t = await r.text();
      document.getElementById('lg-msg').textContent = (r.status===423 ? "嘗試次數過多，已鎖定。" : ("登入失敗："+t));
      return false;
    }
    const j = await r.json();
    localStorage.setItem(LS_KEY, j.token);
    hideLogin();
    return true;
  }catch(e){
    document.getElementById('lg-msg').textContent = "無法連線："+String(e);
    return false;
  }
}

function buildURL(cursor){
  const q = document.getElementById('q').value.trim();
  const from = document.getElementById('from').value.trim();
  const to = document.getElementById('to').value.trim();
  const params = new URLSearchParams();
  if(q) params.set("q", q);
  if(from) params.set("from", from);
  if(to) params.set("to", to);
  if(cursor) params.set("cursor", cursor); // list-bookings.js 支援 cursor；若實作為 next_cursor 也同時帶
  if(cursor) params.set("next_cursor", cursor);
  return API + "?" + params.toString();
}

async function search(cursor){
  if(needLogin()){ showLogin(); return; }
  const url = buildURL(cursor);
  const r = await fetch(url, { headers:{ "Accept":"application/json", "x-admin-token": adminToken() } });
  if(!r.ok){
    const t = await r.text();
    document.getElementById('list').innerHTML = `<div class="empty">讀取失敗：${t}</div>`;
    document.getElementById('btn-next').disabled = true;
    document.getElementById('btn-prev').disabled = PREV_STACK.length===0;
    return;
  }
  const j = await r.json();
  renderList(j.items||[]);
  // pagination
  if(cursor){ PREV_STACK.push(cursor); }
  LAST_CURSOR = j.next_cursor || null;
  document.getElementById('btn-next').disabled = !LAST_CURSOR;
  document.getElementById('btn-prev').disabled = PREV_STACK.length===0;
}

function renderList(items){
  const box = document.getElementById('list');
  if(!items.length){ box.innerHTML = `<div class="empty">沒有符合的資料。</div>`; return; }
  box.innerHTML = "";
  for(const it of items){
    const name = ctxGet(it, "customer") || "—";
    const phone = ctxGet(it, "phone") || "—";
    const service = ctxGet(it, "service") || "—";
    const time = it.created_at ? new Date(it.created_at).toLocaleString() : "—";
    const btn = document.createElement("button");
    btn.className = "row";
    btn.innerHTML = `
      <div class="cell">${name}</div>
      <div class="cell">${phone}</div>
      <div class="cell">${service}</div>
      <div class="cell">${time}</div>
    `;
    btn.addEventListener('click', ()=> openDetails(it));
    box.appendChild(btn);
  }
}

function openDetails(it){
  document.getElementById('detail-type').textContent = it.format ? it.format : (it.resource_type || "raw");
  document.getElementById('d-name').textContent = ctxGet(it,"customer") || "—";
  document.getElementById('d-phone').textContent = ctxGet(it,"phone") || "—";
  document.getElementById('d-service').textContent = ctxGet(it,"service") || "—";
  document.getElementById('d-time').textContent = it.created_at ? new Date(it.created_at).toLocaleString() : "—";
  document.getElementById('d-bytes').textContent = bytes(it.bytes);
  const u = it.secure_url || it.url || "#";
  const a = document.getElementById('d-url'); a.href = u; a.textContent = u ? "開啟檔案" : "—";
  const raw = {
    public_id: it.public_id,
    context: it.context || null,
    metadata: it.metadata || null,
    width: it.width, height: it.height, format: it.format, resource_type: it.resource_type, bytes: it.bytes,
    created_at: it.created_at, url: it.secure_url || it.url
  };
  document.getElementById('d-raw').textContent = JSON.stringify(raw, null, 2);
}

function downloadCSV(){
  if(needLogin()){ showLogin(); return; }
  const rows = [["姓名","電話","服務","建立時間"]];
  const list = document.querySelectorAll('#list .row');
  if(!list.length){ alert("沒有資料可匯出，請先查詢。"); return; }
  list.forEach(r=>{
    const cells = Array.from(r.querySelectorAll('.cell')).map(td=>td.textContent.trim());
    rows.push(cells);
  });
  const csv = rows.map(r=>r.map(csvEsc).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "bookings.csv"; a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('btn-search').addEventListener('click', ()=>{ PREV_STACK=[]; search(null); });
document.getElementById('btn-next').addEventListener('click', ()=>{ if(LAST_CURSOR) search(LAST_CURSOR); });
document.getElementById('btn-prev').addEventListener('click', ()=>{
  if(PREV_STACK.length){ PREV_STACK.pop(); const prior = PREV_STACK.length ? PREV_STACK[PREV_STACK.length-1] : null; search(prior); }
});
document.getElementById('btn-csv').addEventListener('click', downloadCSV);
document.getElementById('lg-submit').addEventListener('click', async ()=>{ const ok=await doLogin(); if(ok) search(null); });
document.getElementById('lg-clear').addEventListener('click', ()=>{ document.getElementById('lg-user').value=""; document.getElementById('lg-pass').value=""; document.getElementById('lg-msg').textContent=""; });

// 初始：若沒有 token 先顯示登入；否則可直接查詢
window.addEventListener('load', ()=>{ if(needLogin()) showLogin(); });
</script>
</body>
</html>
