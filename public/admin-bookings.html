<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>é ç´„è³‡æ–™ç®¡ç†ï¼ˆCloudinaryï¼‰</title>
<link href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" rel="icon" type="image/png"/>
<style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;margin:0;background:#f8fafc;color:#0f172a}
    header{padding:26px 20px 8px}
    h1{margin:0 0 4px;font-size:22px}
    .sub{color:#64748b;font-size:13px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 20px 40px}
    .row{display:flex;gap:10px;align-items:end;margin:10px 0 14px;flex-wrap:wrap}
    .input{display:flex;flex-direction:column;gap:6px}
    .input input{height:38px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;min-width:220px}
    .btn{height:38px;padding:0 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn.primary{background:#0f172a;border-color:#0f172a;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    th,td{padding:12px 14px;font-size:14px;border-bottom:1px solid #e5e7eb}
    th{background:#f9fafb;color:#374151;text-align:left;position:sticky;top:0}
    tr:hover{background:#f6f9ff;cursor:pointer}
    .grid{display:grid;grid-template-columns: 1fr 380px;gap:16px;align-items:start}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .panel h3{margin:0 0 10px}
    .fullview-wrap{display:flex;flex-direction:column;gap:12px}
    .card.fullview{border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card.fullview .card-h{padding:10px 12px;font-weight:600;color:#3b82f6}
    .card.fullview .card-b{padding:8px 12px 12px}
    .card.fullview .row{display:grid;grid-template-columns:160px 1fr;padding:6px 0;border-bottom:1px dotted #eef2f7}
    .card.fullview .row:last-child{border-bottom:0}
    .card.fullview .k{color:#6b7280}
    .card.fullview .v{color:#111827;white-space:pre-wrap}
    .email-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000}
    .email-dialog{width:min(720px,92vw);background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    .email-dialog h3{margin:0 0 10px}
    .email-dialog textarea{width:100%;height:320px;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .email-dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  
/* === Admin Login Modal === */
.login-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:999}
.login-dialog{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);width:min(520px,92vw);padding:18px 18px 16px;border:1px solid #e5e7eb}
.login-h{margin:2px 4px 2px;font-size:20px;font-weight:700;color:#111827}
.login-sub{margin:0 4px 14px;font-size:14px;color:#6b7280}
.login-field{display:flex;flex-direction:column;gap:6px;margin:10px 4px}
.login-label{font-size:13px;color:#374151}
.login-input{height:40px;border-radius:12px;border:1px solid #e5e7eb;padding:8px 12px;background:#fff;outline:none}
.login-input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.login-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.btn-secondary{background:#f3f4f6;border:1px solid #e5e7eb;color:#111827;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn-primary{background:#0f172a;color:#fff;border:1px solid #111827;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}
.login-error{margin:6px 4px 0;color:#b91c1c;font-size:13px;display:none}

/* === Login Dialog è¼¸å…¥æ¡†åœ¨æ‰‹æ©Ÿæ™‚ä¸å…¨è¢å¹• === */
@media (max-width: 640px){
  .login-dialog{
    max-width: 360px;
    width: calc(100% - 32px);
    margin: 0 auto;              /* ç½®ä¸­ */
    border-radius: 16px;
  }
  .login-input input{
    width: 100%;
    box-sizing: border-box;
  }
}


/* === é é¢æ¨™é¡Œèˆ‡èªªæ˜ç½®ä¸­ === */
header {
  text-align: center;
}

header h1 {
  text-align: center;
  margin-bottom: 4px;
}

header .sub {
  text-align: center;
  display: block;
  margin-bottom: 12px;
  color: #64748b;
}


/* === æ‰‹æ©Ÿå­—é«”èˆ‡å¯é»æ€§å„ªåŒ– === */
@media (max-width: 640px){
  html { font-size: 17px; }          /* æå‡æ•´é«”å­—ç´š */
  body { line-height: 1.6; }

  /* æ¨™é¡Œèˆ‡å‰¯æ¨™ */
  header h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  header .sub { font-size: 15px; line-height: 1.4; }

  /* è¡¨å–®è¼¸å…¥èˆ‡æŒ‰éˆ• */
  .input input { font-size: 16px; height: 48px; padding: 0 12px; }
  .btn, .btn.primary { font-size: 16px; height: 48px; }

  /* è¡¨æ ¼å¯è®€æ€§ */
  th { font-size: 15px; font-weight: 600; }
  td { font-size: 15px; line-height: 1.5; }
  tr { min-height: 48px; }

  /* è©³æƒ…é¢æ¿ key/value */
  .card.fullview .k { font-size: 14px; }
  .card.fullview .v { font-size: 16px; }
}


/* === éš±è—è©³æƒ…é¢æ¿å…§å®¹ === */
.card.fullview .card-b {
  display: none;    /* éš±è—å…§å®¹å€ */
}

.card.fullview .card-h::after {
  content: '';      
}

</style>
<style>
/* ====== Mobile-first: é€šç”¨å¯ç”¨æ€§ ====== */
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}
*{ -webkit-tap-highlight-color: transparent; }
button, input, textarea, select{ font-size:16px; } /* iOS é¿å…ç„¦é»æ™‚è‡ªå‹•æ”¾å¤§ */
body{ overscroll-behavior-y: none; }

/* ====== ç‰ˆé¢ï¼šæ”¹ç‚ºå°è¢å¹•å–®æ¬„ã€æ”¾å¤§å¯é»å€åŸŸ ====== */
@media (max-width: 1024px){
  .wrap{ padding:0 16px 24px; }
  .grid{ grid-template-columns: 1fr !important; gap: 12px; }
  header{ padding: calc(16px + var(--safe-top)) 16px 6px; }
  h1{ font-size:20px; }
  .sub{ font-size:13px; }
  .row{ gap:8px; align-items: stretch; }
  .input input{ min-width:0; width:100%; height:44px; }
  .btn, .btn.primary{ height:44px; padding:0 16px; border-radius:12px; }
  .panel{ padding:12px; border-radius:12px; }
}

/* ====== è¡¨æ ¼å¯æ©«å‘æ²å‹• ====== */
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:14px; }
.table-wrap > table{ min-width:720px; }

@media (max-width: 640px){
  th, td{ padding:10px 12px; font-size:14px; }
  tr:hover{ background:#f6f9ff; }
  th{ top:0; }
}

/* éµç›¤å¯é”æ€§ï¼šåˆ—å¯èšç„¦ï¼ˆé…åˆJSåŠ  tabindexï¼‰ */
tr:focus-within{ outline:2px solid #93c5fd; outline-offset:-2px; background:#f0f7ff; }

/* ====== å¡ç‰‡ï¼ˆè©³æƒ…ï¼‰åœ¨æ‰‹æ©Ÿæ›´æ˜“è®€ ====== */
@media (max-width: 640px){
  .card.fullview{ border-radius:12px; }
  .card.fullview .card-h{ padding:10px 12px; font-size:15px; }
  .card.fullview .card-b{ padding:8px 12px 12px; }
  .card.fullview .row{ grid-template-columns: 1fr !important; gap: 2px; padding:8px 0; }
  .card.fullview .k{ font-size:13px; color:#6b7280; }
  .card.fullview .v{ font-size:15px; }
}

/* ====== æ¨¡æ…‹ï¼šæ‰‹æ©Ÿå…¨è¢å¹•ã€å¥½é—œé–‰ã€éµç›¤ä¸é®æ“‹ ====== */
@media (max-width: 640px){
  .login-dialog,
  .email-dialog{
    width: 100vw !important;
    max-width: 100vw !important;
    height: auto;
    max-height: calc(100dvh - 16px - var(--safe-top) - var(--safe-bottom));
    margin: 0;
    border-radius: 16px 16px 0 0;
    padding-bottom: max(16px, var(--safe-bottom));
  }
  .email-dialog textarea{ height: 40dvh; }
}

/* ====== è§¸æ§ç›®æ¨™å¤§å°èˆ‡ç‹€æ…‹ ====== */
.btn, .btn.primary, .btn-primary, .btn-secondary{
  min-width: 44px; min-height: 44px;
}
.btn:active, .btn-primary:active, .btn-secondary:active{ transform: translateY(1px); }

/* ====== iOS èƒŒæ™¯é–å®šï¼ˆé…åˆJSåœ¨é–‹å•Ÿæ¨¡æ…‹æ™‚åŠ  body--modal-openï¼‰ ====== */
body.body--modal-open{ height:100dvh; overflow:hidden; }
</style>
<style>.card.fullview .card-b{display:block !important;}</style>
<script>
    window.ADMIN_TOKEN = "my_super_secret_token_2025";
  </script>
</head>
<body>
<div aria-modal="true" class="login-backdrop" id="loginModal" role="dialog">
<div class="login-dialog">
<div class="login-h">ç®¡ç†ç™»å…¥</div>
<div class="login-sub">è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼ä»¥æª¢è¦–è³‡æ–™ã€‚</div>
<div class="login-field">
<label class="login-label" for="login-username">å¸³è™Ÿ</label>
<input autocomplete="username" class="login-input" id="login-username" placeholder="admin" type="text"/>
</div>
<div class="login-field">
<label class="login-label" for="login-password">å¯†ç¢¼</label>
<input autocomplete="current-password" class="login-input" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
</div>
<div class="login-error" id="login-error">ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¸³è™Ÿå¯†ç¢¼ã€‚</div>
<div class="login-actions">
<button class="btn-secondary" id="login-clear" type="button">æ¸…é™¤</button>
<button class="btn-primary" id="login-submit" type="button">ç™»å…¥</button>
</div>
</div>
</div>
<header>
<h1>é ç´„è³‡æ–™ç®¡ç†ï¼ˆCloudinaryï¼‰</h1>
<div class="sub">åƒ…å±•ç¤º å§“å / é›»è©± / æœå‹™ / å»ºç«‹æ™‚é–“ï¼›è©³æƒ…é¢æ¿å¯ç›´æ¥ã€ŒæŸ¥çœ‹å®Œæ•´å…§å®¹ã€æˆ–ã€Œè²¼ä¸Šä¿¡ä»¶å…§å®¹ä¸¦å›å¡«ã€ã€‚</div>
</header>
<div class="wrap">
<div class="row">
<label class="input"><span>é—œéµå­—</span><input id="q" placeholder="å§“åã€é›»è©±ã€public_idâ€¦"/></label>
<label class="input"><span>èµ·å§‹æ—¥æœŸ</span><input id="start" placeholder="yyyy/mm/dd"/></label>
<label class="input"><span>çµæŸæ—¥æœŸ</span><input id="end" placeholder="yyyy/mm/dd"/></label>
<button class="btn primary" id="btnSearch">æŸ¥è©¢</button>
<button class="btn" id="btnCsv">åŒ¯å‡º CSV</button>
</div>
<div class="grid">
<div>
<div class="table-wrap"><table id="tbl">
<thead><tr><th>å§“å</th><th>é›»è©±</th><th>æœå‹™</th><th>å»ºç«‹æ™‚é–“</th></tr></thead>
<tbody></tbody>
</table></div>
<div id="foot" style="margin-top:8px;color:#6b7280"></div>
</div>
<div class="panel">
<div id="preview" style="min-height:120px;"></div>
<div style="margin-top:8px;display:flex;gap:8px">
<button class="btn" id="btnPaste">è²¼ä¸Šä¿¡ä»¶å…§å®¹ï¼ˆåƒ…é¡¯ç¤ºï¼‰</button>
</div>
</div>
</div>
</div>
<div class="email-modal" id="emailModal">
<div class="email-dialog">
<h3>è²¼ä¸Šä¿¡ä»¶å…§å®¹ â†’ è§£æä¸¦å›å¡«</h3>
<div style="color:#6b7280;font-size:13px;margin-bottom:6px">è«‹å¾ Gmail ç›´æ¥è¤‡è£½å¯è¦‹æ–‡å­—è²¼ä¸Šï¼›æœƒè‡ªå‹•è§£ææ¬„ä½ä¸¦åŒæ­¥åˆ° Cloudinary contextã€‚</div>
<textarea id="emailPaste"></textarea>
<div class="actions">
<button class="btn" id="emailCancel">å–æ¶ˆ</button>
<button class="btn primary" id="emailApply">è§£æä¸¦å›å¡«</button>
</div>
<div id="emailMsg" style="color:#2563eb;font-size:13px;margin-top:6px"></div>
</div>
</div>
<script>
const API_LIST = "/.netlify/functions/list-bookings";
const API_LOGIN = "/.netlify/functions/auth-login";
const API_UPDATE_CTX = "/.netlify/functions/update-booking-context";
let ADMIN_TOKEN = localStorage.getItem("admin_token") || "";
let CURRENT_ITEM = null;
let CURRENT_LIST = [];
const $ = (s)=>document.querySelector(s);

function needLogin(){ return !ADMIN_TOKEN; }

async function login(){
  return new Promise((resolve)=>{
    const modal = document.getElementById('loginModal');
    const uEl = document.getElementById('login-username');
    const pEl = document.getElementById('login-password');
    const err = document.getElementById('login-error');
    const btnSubmit = document.getElementById('login-submit');
    const btnClear = document.getElementById('login-clear');
    // init
    err.style.display = 'none';
    uEl.value = '';
    pEl.value = '';
    modal.style.display = 'flex';
    uEl.focus();

    const doSubmit = async ()=>{
      btnSubmit.disabled = true;
      err.style.display = 'none';
      const u = uEl.value.trim();
      const p = pEl.value;
      if(!u || !p){ err.textContent = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"; err.style.display='block'; btnSubmit.disabled=false; return; }
      try{
        const r = await fetch(API_LOGIN, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ username:u, password:p }) });
        const j = await r.json();
        if (!r.ok){ err.textContent = j.message || j.error || "ç™»å…¥å¤±æ•—"; err.style.display='block'; btnSubmit.disabled=false; return; }
        ADMIN_TOKEN = j.token; localStorage.setItem("admin_token", ADMIN_TOKEN);
        modal.style.display = 'none';
        resolve(true);
      }catch(e){
        err.textContent = "ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦"; err.style.display='block';
        btnSubmit.disabled = false;
      }
    };

    btnSubmit.onclick = doSubmit;
    btnClear.onclick = ()=>{ uEl.value=''; pEl.value=''; uEl.focus(); };
    pEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSubmit(); });
    uEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') pEl.focus(); });
  });
}
function fmtDate(d){ return new Date(d).toLocaleString(); }
function pick(obj, keys, fb=""){ for(const k of keys){ if(obj && obj[k]!=null && String(obj[k]).trim()!=="") return String(obj[k]).trim(); } return fb; }


function decodeArray(val){
  try {
    const decoded = decodeURIComponent(val || "");
    const parsed = JSON.parse(decoded);
    if (Array.isArray(parsed)) return parsed.join(", ");
    return parsed;
  } catch (e){
    return val;
  }
}


function normalizeContext(item){
  const c = (item.context && item.context.custom) ? item.context.custom : (item.context || {});
  const m = item.metadata || {};
  const get = (names, fb="") => pick(c, names, pick(m, names, fb));
  return {
    bulk_notes: get(["bulk_notes", "å¤§é‡æ¸…æ´—å‚™è¨»"]),
    group_notes: get(["group_notes", "åœ˜è³¼å‚™è¨»"]),
    service_description: get(["service_description", "å…¶ä»–æœå‹™èªªæ˜"]),
    contact_method: get(["contact_method"]),
    social_name: get(["social_name"]),
    housing_type: get(["housing_type"]),
    contact_time_preference: decodeArray(get(["contact_time_preference"])),
    washer_count: get(["washer_count"]),
    washer_floor: decodeArray(get(["washer_floor"])),
    tank_count: get(["tank_count"]),
    pipe_service: get(["pipe_service"]),
    pipe_reason: decodeArray(get(["pipe_reason"])),
    name: get(["name","customer_name","fullname","å§“å"]),
    phone: get(["phone","phone_number","mobile","tel","é›»è©±"]),
    service: get(["service","service_category","service_item","select_service","æœå‹™"]),
    address: get(["address","åœ°å€"]),
    brand: decodeArray(get(["ac_brand","brand","å†·æ°£å“ç‰Œ"])),
    ac_type: get(["ac_type","å†·æ°£é¡å‹"]),
    count: get(["ac_count","count","quantity","æ¸…æ´—æ•¸é‡"]),
    floor: decodeArray(get(["indoor_floor","floor","æ¨“å±¤","å®¤å…§æ©Ÿæ‰€åœ¨æ¨“å±¤"])),
    is_inverter: get(["ac_transformer_series","æ˜¯å¦ç‚ºã€Œè®Šå½¢é‡‘å‰›ç³»åˆ—ã€å†·æ°£æ©Ÿå‹ï¼Ÿ"]),
    antifungus: get(["anti_mold","antifungus","å†·æ°£é˜²éœ‰æŠ—èŒè™•ç†"]),
    ozone: get(["ozone","è‡­æ°§æ®ºèŒæ¶ˆæ¯’"]),
    extra_service: get(["extra_service","å…¶ä»–æ¸…æ´—æœå‹™"]),
    line_id: get(["line_or_fb","line_id","LINE","è¯çµ¡Line"]),
    fb_name: get(["social_name","fb_name","facebook","FB","LINE & Facebook å§“å"]),
    timeslot: get(["timeslot","é ç´„æ™‚æ®µ"]),
    date: get(["date","é ç´„æ—¥æœŸ"]),
    note: get(["note","å‚™è¨»"]),
  };
}

function kv(label, value){ const s=(v)=>(v==null||String(v).trim()==="")?"â€”":String(v); return `<div class="row"><div class="k">${label}</div><div class="v">${s(value)}</div></div>`; }
function sectionCard(title, rowsHtml){ return `<div class="card fullview"><div class="card-h">${title}</div><div class="card-b">${rowsHtml}</div></div>`; }
function renderFullContent(item, mount){
  const data = normalizeContext(item);
  const blocks = [];
  
  
if (data.service === "å†·æ°£æ¸…æ´—") {
  blocks.push(sectionCard("æœå‹™è³‡è¨Š",
    kv("æœå‹™é¡åˆ¥", data.service) +
    kv("å†·æ°£é¡å‹", data.ac_type) +
    kv("æ¸…æ´—æ•¸é‡", data.count) +
    kv("å®¤å…§æ©Ÿæ‰€åœ¨æ¨“å±¤", data.floor) +
    kv("å†·æ°£å“ç‰Œ", data.brand) +
    kv("æ˜¯å¦ç‚ºã€Œè®Šå½¢é‡‘å‰›ç³»åˆ—ã€å†·æ°£æ©Ÿå‹ï¼Ÿ", data.is_inverter)
  ));
} 
else {
  blocks.push(sectionCard("æœå‹™è³‡è¨Š",
    kv("æœå‹™é¡åˆ¥", data.service)
  ));
}

if (data.service === "åœ˜è³¼é ç´„æ¸…æ´—" || data.service === "å¤§é‡æ¸…æ´—éœ€æ±‚") {
  let descTitle = (data.service === "åœ˜è³¼é ç´„æ¸…æ´—") ? "åœ˜è³¼é ç´„èªªæ˜" : "å¤§é‡éœ€æ±‚èªªæ˜";
  blocks.push(sectionCard(descTitle, kv("å…§å®¹", data.group_notes || data.bulk_notes)));
}


if (data.service_description) {
  blocks.push(sectionCard("å…¶ä»–æœå‹™èªªæ˜", kv("å…§å®¹", data.service_description)));
}


  blocks.push(sectionCard("é˜²éœ‰ãƒ»æ¶ˆæ¯’ï½œåŠ è³¼æœå‹™å°ˆå€", kv("å†·æ°£é˜²éœ‰æŠ—èŒè™•ç†", data.antifungus ? "éœ€è¦" : "ä¸éœ€è¦") + kv("è‡­æ°§æ®ºèŒæ¶ˆæ¯’", data.ozone ? "éœ€è¦" : "ä¸éœ€è¦")));
  blocks.push(sectionCard("å…¶ä»–æ¸…æ´—æœå‹™",
  kv("ç›´ç«‹å¼æ´—è¡£æ©Ÿæ¸…æ´—ï¼ˆå°æ•¸ï¼‰", data.washer_count) +
  kv("æ´—è¡£æ©Ÿæ¨“å±¤", data.washer_floor) +
  kv("å®¶ç”¨æ°´å¡”æ¸…æ´—ï¼ˆé¡†æ•¸ï¼‰", data.tank_count) +
  kv("è‡ªä¾†æ°´ç®¡æ¸…æ´—æˆ¶å‹æ–¹æ¡ˆ", data.pipe_service) +
  kv("è‡ªä¾†æ°´ç®¡æ¸…æ´—åŸå› ", data.pipe_reason)
));
  blocks.push(sectionCard("è¯ç¹«è³‡æ–™",
    kv("è¯çµ¡äºº", data.name) +
    kv("è¯çµ¡é›»è©±", data.phone) +
    kv("èˆ‡æˆ‘å€‘è¯ç¹«æ–¹å¼", data.contact_method) +
    kv("LINE æˆ– Facebook åç¨±", (data.contact_method?.includes("LINE") || data.contact_method?.includes("Facebook")) ? data.social_name : "")  +
    kv("å±…ä½åœ°å‹æ…‹", data.housing_type) +
    kv("æ–¹ä¾¿è¯ç¹«æ™‚é–“", data.contact_time_preference) +
    kv("åœ°å€", data.address) +
    kv("å¯å®‰æ’æ™‚æ®µ", decodeArray(data.timeslot)) +
    kv("å‚™è¨»", data.note) +
    kv("å»ºç«‹æ™‚é–“", new Date(item.created_at).toLocaleString())
  ));
  mount.innerHTML = `<div class="fullview-wrap">${blocks.join("")}</div>`;
}

async function doSearch(){
  const payload = { q: $("#q").value.trim(), start: $("#start").value.trim(), end: $("#end").value.trim(), max: 50 };
  const r = await fetch(API_LIST, { method:"POST", headers:{ "Content-Type":"application/json", "x-admin-token": ADMIN_TOKEN }, body: JSON.stringify(payload) });
  if (r.status === 401){ ADMIN_TOKEN=""; localStorage.removeItem("admin_token"); if(await login()) return doSearch(); return; }
  const data = await r.json();
  const list = data.resources || data.items || [];
  CURRENT_LIST = list;
  const tbody = $("#tbl tbody"); tbody.innerHTML = "";
  for (const it of list){
    const ctx = normalizeContext(it);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${ctx.name || "(æœªå¡«)"}</td><td>${ctx.phone||""}</td><td>${ctx.service||""}</td><td>${fmtDate(it.created_at)}<button onclick="deleteBooking(item.public_id)" title="åˆªé™¤" style="margin-left:8px;color:red;">ğŸ—‘</button></td>`;
    tr.onclick = ()=> openDetails(it);
    tbody.appendChild(tr);
  }
  $("#foot").textContent = `å…± ${data.total_count ?? list.length} ç­†`;
}

function openDetails(item){
  CURRENT_ITEM = item;
  const pv = $("#preview");
  if (pv) pv.innerHTML = "";
  // é»é¸å·¦å´åˆ—æ™‚ï¼Œé¡¯ç¤º Cloudinary è©³ç´°å…§å®¹
  renderFullContent(item, $("#preview"));
}

$("#btnSearch").onclick = () => doSearch();
$("#btnCsv").onclick = () => {
  const rows = [["å§“å","é›»è©±","æœå‹™","å»ºç«‹æ™‚é–“"]];
  for (const it of CURRENT_LIST){
    const c = normalizeContext(it);
    rows.push([c.name||"", c.phone||"", c.service||"", fmtDate(it.created_at)]);
  }
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "bookings.csv"; a.click(); URL.revokeObjectURL(a.href);
};

// paste-from-email modal
$("#btnPaste").onclick = ()=>{
  if (!CURRENT_ITEM) { alert("è«‹å…ˆé»åˆ—è¡¨é¸æ“‡ä¸€ç­†è³‡æ–™"); return; }
  $("#emailPaste").value = ""; $("#emailMsg").textContent=""; $("#emailModal").style.display="flex";
};
$("#emailCancel").onclick = ()=> $("#emailModal").style.display="none";
function escapeHtml(s){
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

$("#emailApply").onclick = async ()=>{
  const text = $("#emailPaste").value;
  const msg = $("#emailMsg");
  const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const kvs = {};
  for (const ln of lines){
    let m = ln.match(/^(.+?)[:ï¼š]\s*(.+)$/);
    if (!m) m = ln.match(/^(.+?)\s+(.+)$/);
    if (m){ kvs[m[1].trim()] = m[2].trim(); }
  }
  const pick = (obj, keys)=>{ for(const k of keys){ if(obj[k]!=null && String(obj[k]).trim()!=="") return String(obj[k]).trim(); } return ""; };
  const ctx = {
    name: pick(kvs, ["è¯çµ¡äºº","å§“å","name"]),
    phone: pick(kvs, ["è¯çµ¡é›»è©±","é›»è©±","phone"]),
    service: pick(kvs, ["æœå‹™é¡åˆ¥","æœå‹™","service"]),
    address: pick(kvs, ["åœ°å€","ä½å€","address"]),
    ac_type: pick(kvs, ["å†·æ°£é¡å‹","ac_type"]),
    count: pick(kvs, ["æ¸…æ´—æ•¸é‡","æ•¸é‡","count"]),
    floor: pick(kvs, ["å®¤å…§æ©Ÿæ‰€åœ¨æ¨“å±¤","æ¨“å±¤","floor"]),
    brand: pick(kvs, ["å†·æ°£å“ç‰Œ","brand"]),
    is_inverter: pick(kvs, ["æ˜¯å¦ç‚ºè®Šé »æ©Ÿå‹ç³»åˆ—","è®Šé »","is_inverter"]),
    antifungus: pick(kvs, ["å†·æ°£é˜²éœ‰æŠ—èŒè™•ç†","antifungus"]),
    ozone: pick(kvs, ["è‡­æ°§æ®ºèŒæ¶ˆæ¯’","ozone"]),
    extra_service: pick(kvs, ["å…¶ä»–æ¸…æ´—æœå‹™","extra_service"]),
    line_id: pick(kvs, ["LINE","LINE / Facebook","line_id"]),
    fb_name: pick(kvs, ["LINE & Facebook å§“å","facebook","fb_name"]),
    date: pick(kvs, ["é ç´„æ—¥æœŸ","date"]),
    timeslot: pick(kvs, ["é ç´„æ™‚æ®µ","æ™‚æ®µ","timeslot"]),
    note: pick(kvs, ["å‚™è¨»","note"]),
    source: pick(kvs, ["ä¾†æº","subject","page_title"]),
  };
  Object.keys(ctx).forEach(k=>{ if(!ctx[k]) delete ctx[k]; });

  if (!text || !lines.length){
    msg.textContent = "æ²’æœ‰è®€åˆ°å¯è§£æçš„æ–‡å­—ï¼Œè«‹ç¢ºèªè²¼ä¸Šçš„æ˜¯ç´”æ–‡å­—å…§å®¹ï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸å¯«å›ï¼‰";
    return;
  }

  // åªé¡¯ç¤ºåœ¨è©³æƒ…é¢æ¿ï¼ˆä¸å¯«å›ï¼‰
  const pv = $("#preview");
const toRows = (o)=> Object.keys(o).length
    ? Object.entries(o).map(([k,v]) => `<div class="row"><div class="k">${k}</div><div class="v">${escapeHtml(v)}</div></div>`).join("")
    : `<div class="row"><div class="k">è§£æçµæœ</div><div class="v">ï¼ˆæœªåµæ¸¬åˆ°å¯ç”¨æ¬„ä½ï¼‰</div></div>`;

  const rawCard = `
    <div class="card fullview">
      <div class="card-h">Email åŸå§‹å…§å®¹ï¼ˆåƒ…é¡¯ç¤ºï¼‰</div>
      <div class="card-b">
        <div class="row"><div class="k">è²¼ä¸Šæ–‡å­—</div><div class="v" style="white-space:pre-wrap">${escapeHtml(text)}</div></div>
      </div>
    </div>`;

  const parsedCard = `
    <div class="card fullview">
      <div class="card-h">è§£æçµæœï¼ˆæœªå¯«å›ï¼‰</div>
      <div class="card-b">${toRows(ctx)}</div>
    </div>`;

  pv.innerHTML = `<div class="fullview-wrap">${rawCard}${parsedCard}</div>`;

  // æç¤ºï¼‹é—œé–‰è¦–çª—
  msg.textContent = "å·²é¡¯ç¤ºåœ¨å³å´è©³æƒ…ï¼ˆæœªå¯«å›ï¼‰";
  $("#emailModal").style.display = "none";
};

(async ()=>{ if (needLogin()){ const ok = await login(); if(!ok) return; } doSearch(); })();
</script>
<script>
  // 1) æ¨¡æ…‹é–‹é—œæ™‚é–å®šèƒŒæ™¯æ²å‹•
  function lockScrollForModal(open){
    document.body.classList.toggle('body--modal-open', !!open);
  }

  // 2) è¡¨æ ¼åˆ—æ”¯æ´ Enter/Space è§¸ç™¼ clickï¼ˆç„¡éšœç¤™ï¼‰
  document.addEventListener('keydown', (e)=>{
    const tr = e.target && e.target.closest && e.target.closest('tr[tabindex="0"]');
    if(!tr) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      tr.click();
    }
  });

  // 3) è‡ªå‹•ç‚ºè¡¨æ ¼åˆ—åŠ  tabindex="0"ï¼Œåˆæ¬¡èˆ‡å‹•æ…‹æ–°å¢éƒ½æœƒå¥—ç”¨
  function enhanceRowsTabIndex(){
    document.querySelectorAll('table#tbl tbody tr').forEach(tr=>{
      if(!tr.hasAttribute('tabindex')) tr.setAttribute('tabindex','0');
    });
  }
  const mo = new MutationObserver(enhanceRowsTabIndex);
  window.addEventListener('DOMContentLoaded', ()=>{
    enhanceRowsTabIndex();
    const tbody = document.querySelector('table#tbl tbody');
    if(tbody) mo.observe(tbody, {childList:true, subtree:true});
  });

  // 4) iOSï¼šè¼¸å…¥æ¡†èšç„¦æ™‚ï¼Œé¿å…è¢«éµç›¤é®ä½
  const autoScrollInputs = ['INPUT','TEXTAREA'];
  document.addEventListener('focusin', (e)=>{
    if(autoScrollInputs.includes(e.target.tagName)){
      setTimeout(()=>{ e.target.scrollIntoView({block:'center'}); }, 100);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll("button");
  buttons.forEach(btn => {
    if (btn.textContent.includes("è²¼ä¸Šä¿¡ä»¶å…§å®¹ï¼ˆåƒ…é¡¯ç¤ºï¼‰")) {
      btn.style.display = "none";
    }
  });
});
</script>
<script>
      async function deleteBooking(publicId) {
        if (!publicId) return alert("ç„¡æ³•å–å¾— public_id");
        if (!confirm("æ˜¯å¦ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®ï¼Ÿ")) return;

        try {
          const response = await fetch(
            `/.netlify/functions/delete-booking?public_id=${encodeURIComponent(publicId)}`,
            {
              method: "DELETE",
              headers: {
                "x-admin-token": window.ADMIN_TOKEN
              }
            }
          );

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "åˆªé™¤å¤±æ•—");

          alert("åˆªé™¤æˆåŠŸï¼");
          location.reload();
        } catch (err) {
          alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + err.message);
        }
      }
    </script><script>
    async function deleteBooking(publicId) {
      if (!publicId) return alert("ç„¡æ³•å–å¾— public_id");
      if (!confirm("æ˜¯å¦ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®ï¼Ÿ")) return;

      try {
        const response = await fetch(
          `/.netlify/functions/delete-booking?public_id=${encodeURIComponent(publicId)}`,
          {
            method: "DELETE",
            headers: {
              "x-admin-token": window.ADMIN_TOKEN
            }
          }
        );

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "åˆªé™¤å¤±æ•—");

        alert("åˆªé™¤æˆåŠŸï¼");
        location.reload();
      } catch (err) {
        alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + err.message);
      }
    }
    </script></body>
</html>
